<html>
  <head>
    <style>
      #header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background-color: white;
        border-bottom: 1px solid #ccc;
        padding: 10px;
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        align-items: start;
      }
      #countdown {
        font-size: 48px;
        font-weight: bold;
        color: #666;
      }
      #content {
        margin-top: 120px;
      }
      ins { background-color: #90EE90; text-decoration: none; }
      del { background-color: #FFB6C1; }
    </style>
  </head>
  <body>
    <div id="container">
    </div>

    <script>
     // Polyfill for CommonJS module.exports in browser
     var module = { exports: {} };
    </script>
    <script src="vendor/htmldiff.js"></script>
    <script>
     const htmldiff = module.exports.default;

     let allRevisions = [];
     let revisionHtml = [];
     let currentRevisionIndex = 0;
     let pageTitle = '';
     let countdownInterval = null;

     function displayRevision() {
       let content;

       if (currentRevisionIndex === 0) {
         content = revisionHtml[0];
       } else {
         const oldHtml = revisionHtml[currentRevisionIndex - 1];
         const newHtml = revisionHtml[currentRevisionIndex];
         content = htmldiff.execute(oldHtml, newHtml);
       }

       container.innerHTML = `
         <div id="header">
           <div>
             <div class="header">Article: ${pageTitle}</div>
             <div class="header">Total number of edits: ${allRevisions.length}</div>
             <div class="header">Showing revision ${currentRevisionIndex + 1} of ${allRevisions.length}</div>
             <button id="nextBtn" ${currentRevisionIndex >= allRevisions.length - 1 ? 'disabled' : ''}>Next Revision</button>
           </div>
           <div id="countdown">3</div>
         </div>
         <div id="content">${content}</div>
       `;

       document.getElementById('nextBtn').addEventListener('click', () => {
         clearInterval(countdownInterval);
         nextRevision();
       });

       // Start countdown
       if (currentRevisionIndex < allRevisions.length - 1) {
         clearInterval(countdownInterval);
         let count = 3;
         document.getElementById('countdown').textContent = count;

         countdownInterval = setInterval(() => {
           count--;
           if (count > 0) {
             document.getElementById('countdown').textContent = count;
           } else {
             clearInterval(countdownInterval);
             nextRevision();
           }
         }, 1000);
       } else {
         document.getElementById('countdown').textContent = '';
       }

       // Scroll to first change if not the first revision
       if (currentRevisionIndex > 0) {
         setTimeout(() => {
           const firstChange = document.querySelector('ins, del');
           if (firstChange) {
             const headerHeight = document.getElementById('header').offsetHeight;
             const elementPosition = firstChange.getBoundingClientRect().top + window.scrollY;
             window.scrollTo({
               top: elementPosition - headerHeight - 20,
               behavior: 'smooth'
             });
           }
         }, 0);
       }
     }

     async function nextRevision() {
       if (currentRevisionIndex >= allRevisions.length - 1) return;

       currentRevisionIndex++;

       // Fetch content if we don't have it yet
       if (!revisionHtml[currentRevisionIndex]) {
         const revId = allRevisions[currentRevisionIndex].revid;
         const contentUrl = `https://en.wikipedia.org/w/api.php?action=parse&oldid=${revId}&format=json&origin=*`;
         const contentResponse = await fetch(contentUrl);
         const contentData = await contentResponse.json();
         revisionHtml[currentRevisionIndex] = contentData.parse.text['*'];
       }

       displayRevision();
     }

     async function fetchRandomArticleEdits() {
       const headers = {
         'User-Agent': 'MediaWiki REST API docs examples/0.1 (https://meta.wikimedia.org/wiki/User:APaskulin_(WMF))'
       };

       try {
         // First, get a random Wikipedia article
         const randomUrl = 'https://en.wikipedia.org/w/api.php?action=query&list=random&rnnamespace=0&rnlimit=1&format=json&origin=*';
         const randomResponse = await fetch(randomUrl);
         const randomData = await randomResponse.json();
         pageTitle = randomData.query.random[0].title;

         container.innerHTML = `<div class="header">Loading edits for: ${pageTitle}...</div>`;

         // Fetch all revisions (up to 1000 with pagination)
         let continueToken = null;

         while (allRevisions.length < 1000) {
           const historyUrl = `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(pageTitle)}&prop=revisions&rvlimit=500&rvdir=newer&format=json&origin=*${continueToken ? '&rvcontinue=' + continueToken : ''}`;
           const historyResponse = await fetch(historyUrl);
           const historyData = await historyResponse.json();
           const page = historyData.query.pages[Object.keys(historyData.query.pages)[0]];

           if (page.revisions) {
             allRevisions = allRevisions.concat(page.revisions);
           }

           if (historyData.continue && historyData.continue.rvcontinue && allRevisions.length < 1000) {
             continueToken = historyData.continue.rvcontinue;
           } else {
             break;
           }
         }

         // Get the original article HTML (first revision)
         const firstRevId = allRevisions[0].revid;
         const contentUrl = `https://en.wikipedia.org/w/api.php?action=parse&oldid=${firstRevId}&format=json&origin=*`;
         const contentResponse = await fetch(contentUrl);
         const contentData = await contentResponse.json();
         revisionHtml[0] = contentData.parse.text['*'];

         displayRevision();
       } catch (error) {
         container.innerHTML = '<div class="header">Error loading data: ' + error.message + '</div>';
       }
     }

     fetchRandomArticleEdits();
    </script>
  </body>
</html>
